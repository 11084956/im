<!DOCTYPE html>

<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>聊天室demo</title>
    <link rel="stylesheet" href="./static/chartroom.css">
</head>
<body>
<div class="m-head">
    <div class="g-doc">
        <div class="logo item">聊天室demo</div>


        <div class="info item">
            <img src="./static/9302457.jpeg" alt="头像" id="avatar">
            <!--a href="./roomManage.html" id="nickName">匿名</a-->
            <span id="nickName">at</span>
            <a href="#" id="chatroom-login" style="display: none;">登录</a>
            <a id="chatroom-logout">注销</a>
        </div>

    </div>
</div>
<div class="g-doc">
    <div class="m-room" id="room">
        <div class="g-left">
            <div class="info">
                <div class="avatar">
                    <img class="image" id="roomAvatar" src="./static/9302457.jpeg">
                </div>
                <div class="detail">
                    <p class="title" id="roomTitle">AT直播间</p>
                    <p class="desc">主播：<span id="roomCreator">AT</span>&nbsp;&nbsp;在线人数：<span id="roomOnlineMemberNum">1</span></p>
                </div>
            </div>
            <div class="media">
                <img src="./static/WechatIMG237.jpeg" id="video" class="">
            </div>
        </div>
        <div class="g-right">
            <div class="m-status hide" id="linkStatus">连接中。。。</div>
            <div class="announcement_title">
                直播公告
            </div>
            <div class="announcement" id="roomAnnouncement">暂无公告</div>
           <ul class="tab">
                <li class="crt j-tab" data-value="chat">直播互动</li>
               <li class="crt j-tab" data-value="mem"></li>

            </ul>
            <div class="chat j-pannel j-chat" id="msg">

            </div>

            <div id="chatroom-verified">
                <div class="edit">
                    <textarea class="editText" id="editText" placeholder=""></textarea>
                </div>
                <div class="sendBtn">
                    <a class="u-btn btn" id="sentText">发送</a>
                    <a class="btn custom" id="customBtn"></a>
                    <a class="btn emoji" id="emoji"></a>
                </div>
            </div>
            <div id="chatroom-anonymous" style="display: none;">
                <em class="loginWarn">登录后方可发送消息</em>
                <div class="loginBtn">
                    <a href="#" class="u-btn btn">登录聊天室</a>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="js/jquery.min.js?v=2.1.4"></script>
<script type="text/javascript">


    $(document).ready(function()
    {
        var auth = getCookie("auth")

        var jsonData = {"Auth":auth}

        $.ajax({
            //几个参数需要注意一下
            type: "POST",//方法类型
            dataType: "json",//预期服务器返回的数据类型
            url: "http://localhost:8080/v1/user/check_auth" ,//url
            data:  JSON.stringify(jsonData) ,
            success: function (result) {
                if (result.code == 0) {

                }else  {
                    alert("请先简单注册登录")
                    window.location.href="http://localhost:1999/register.html";
                }

            },
            error : function() {
                alert("异常！");
            }
        });
        // l
        websocket()


    });
    function websocket() {
        //调用websocket对象建立连接：
        var msg            = document.getElementById("msg");
        //参数：ws/wss(加密)：//ip:port （字符串）
        var websocket = new WebSocket("ws://localhost:6911/ws");
        var data = {"auth":getCookie("auth"),"roomId":1}

        //onopen监听连接打开
        websocket.onopen = function (evt) {
            websocket.send(JSON.stringify(data))
            //websocket.readyState 属性：
            /*
            CONNECTING    0    The connection is not yet open.
            OPEN    1    The connection is open and ready to communicate.
            CLOSING    2    The connection is in the process of closing.
            CLOSED    3    The connection is closed or couldn't be opened.
            */

        };
        //监听连接关闭
        //    websocket.onclose = function (evt) {
        //        console.log("Disconnected");
        //    };
        //onmessage 监听服务器数据推送
        websocket.onmessage = function (evt) {
            var data = JSON.parse(evt.data)

            var innerInfo = '<div class="item" ><p class="nick guest j-nick " data-role="guest" data-account="oqzw45cvvheebryvjifu8ido6fmm">'+ data.formUserName +'</p><p class="text">' + data.msg +'</p></div>'
            msg.innerHTML += innerInfo +'<br>';
            // msg.innerHTML += evt.data +'<br>';

//        console.log('Retrieved data from server: ' + evt.data);
        };
    }


    function song(){
        var text = document.getElementById('text').value;
        document.getElementById('text').value = '';
        //向服务器发送数据
        websocket.send(text);
    }

    function getCookie(name)
    {
        var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");

        if(arr=document.cookie.match(reg))

            return unescape(arr[2]);
        else
            return null;
    }


    // var msg = document.getElementById("msg");



    //监听连接错误信息
    //    websocket.onerror = function (evt, e) {
    //        console.log('Error occured: ' + evt.data);
    //    };

</script>




</body></html>